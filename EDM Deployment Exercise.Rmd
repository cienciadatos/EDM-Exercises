---
title: "EDM - Deployment Exercise"
author: "Pablo Bolta, Jacinto Dobón y Jorge López"
date: "5/4/2023"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(dplyr)
library(plotly)
library(reshape2)
library(lubridate)
library(randomForestSRC)
```

## 1.- One dimensional Partial Dependence Plot.
The partial dependence plot shows the marginal effect of a feature on the predicted outcome of a previously fit model. 
 
### EXERCISE:
Apply PDP to the regression example of predicting bike rentals. Fit a random forest approximation for the prediction of bike rentals (cnt). Use the partial dependence plot to visualize the relationships the model learned. Use the slides shown in class as model.  

### QUESTION:
Analyse the influence of days since 2011, temperature, humidity and wind speed on the predicted bike counts.

___________

En primer lugar, cargamos los datos de la carpeta data, obtenida mediante el uso de DVC. En ella se encuentran los archivos .csv y los .dvc, almacenados en el repositorio de Google Drive. Una vez cargamos la data, procedemos a transformar las variables y a filtrar por fecha desde 2011 en adelante. 

```{r exercise_1}
days <- read.csv("data/day.csv")

days$dteday <- as_date(days$dteday)
days_since <- select(days, workingday, holiday, temp, hum, windspeed, cnt)
days_since$days_since_2011 <- int_length(interval(ymd("2011-01-01"), days$dteday)) / (3600*24)
days_since$SUMMER <- ifelse(days$season == 3, 1, 0)
days_since$FALL <- ifelse(days$season == 4, 1, 0)
days_since$WINTER <- ifelse(days$season == 1, 1, 0)
days_since$MISTY <- ifelse(days$weathersit == 2, 1, 0)
days_since$RAIN <- ifelse(days$weathersit == 3 | days$weathersit == 4, 1, 0)
days_since$temp <- days_since$temp * 47 - 8
days_since$hum <- days_since$hum * 100
days_since$windspeed <- days_since$windspeed * 67
```

Una vez finalizamos la transformación y filtrado de las variables, pasamos al entrenamiento del modelo con Random Forest. De igual manera, realizamos las predicciones correspondientes. El código se muestra a continuación:

```{r rf_model_and_results}
model.rf <- rfsrc(cnt~., data=days_since)

results <- select(days_since, days_since_2011, temp, hum, windspeed, cnt)
len <- nrow(days_since)
for(c in names(results)[1:4])
{
  for(i in 1:len){
    r <- days_since
    r[[c]] <- days_since[[c]][i]
    pred <- predict(model.rf, r)$predicted
    results[[c]][i] <- sum(pred) / len
  }
}
```

Por último, ploteamos los resultados usando el gráfico de dependencias parciales para las variables de "days_since_2011", "temp", "hum" y "windspeed". 

```{r plot_results}
plot_1 <- ggplot(days_since, aes(x=days_since_2011, y=results$days_since_2011)) +
          geom_line() + 
          ylim(c(0,6000)) + 
          geom_rug(alpha=0.1, sides="b") + 
          ylab("Prediction") + 
          xlab("Days since 2011")

plot_2 <- ggplot(days_since, aes(x=temp, y=results$temp)) + 
          geom_line() + 
          ylim(c(0,6000)) + 
          geom_rug(alpha=0.1, sides="b") + 
          xlab("Temperature")

plot_3 <- ggplot(days_since, aes(x=hum, y=results$hum)) + 
          geom_line() + 
          ylim(c(0,6000)) + 
          geom_rug(alpha=0.1, sides="b") + 
          xlab("Humidity")

plot_4 <- ggplot(days_since, aes(x=windspeed, y=results$windspeed)) + 
          geom_line() + 
          ylim(c(0,6000)) + 
          geom_rug(alpha=0.1, sides="b") + 
          xlab("Wind speed")

subplot(plot_1, plot_2, plot_3, plot_4, 
          shareX = FALSE, 
          shareY = TRUE, 
          titleX = TRUE)
```

### INTERPRETATION

**`Days since 2011`**: A medida que vamos avanzando en el tiempo (desde 2011), el alquiler de bicicletas tiende a aumentar. Es importantes destacar dos aspectos fundamentales:

   1. Entre 130 y 350 días, la diferencia de la importancia es mínima en esta variable (siempre en torno a 3700-3800 bicicletas más).
   2. La tendencia es siempre creciente, salvo en el tramo final. A partir del día 648 el alquiler de bicicletas disminuye de 5679 a 5104. 
   
Estas explicaciones son fiables, pues se tienen observaciones para todos los valores de esta variable.

**`Temperature`**: Lo más destacable de esta variable es que a medida que la temperatura aumenta se alquilan más bicicletas, pasando 3180 bicicletas con -5 grados a 5274 bicicletas con 20 grados. En general, se alquilan más bicicletas cuando la temperatura es agradable (16-26 grados). Cuando hace frío o calor, se alquilan cada vez menos bicicletas.

**`Humidity`**: Para valores de humedad menores del 50%, el número de bicicletas alquiladas se mantiene constante (unas 4700 bicicletas). Por otro lado, a medida que aumenta la humedad (desde el 50%), se alquilan cada vez menos bicicletas, alcanzando su mínimo (3704 bicicletas) cuando la humedad alcanza el 97%. No obstante, estas explicaciones deben ser tomadas con cuidado cuando la humedad se encuentra por debajo del 37% o por encima del 92%, ya que en esos casos no hay muchas observaciones, haciendo que las explicaciones no sean del todo fiables.

**`Wind speed`**: El modelo predice que la tendencia de esta variable es claramente decreciente. A medida que aumenta la velocidad del viento se alquilan menos bicicletas, pasando de 4636 con velocidad del viento igual a 1.5; a 4178 cuando la velocidad del viento tiene un valor de 24. Para valores mayores que 24, el número de bicicletas alquiladas se mantiene estable en 4178. No obstante, para valores mayores que 24, hay que reconsiderar la fiabilidad de estas explicaciones, pues hay muy pocas observaciones.

## 2.- Bidimensional Partial Dependency Plot.

### EXERCISE:
Generate a 2D Partial Dependency Plot with humidity and temperature to predict the number of bikes rented depending on those parameters.

> **BE CAREFUL: due to the size, extract a set of random samples from the BBDD before generating the data for the Partial Dependency Plot.**

Show the density distribution of both input features with the 2D plot as shown in the class slides. 

TIP: Use geom_tile() to generate the 2D plot. Set width and height to avoid holes. 

### QUESTION:
Interpret the results.
```{r 2d_pdp}
# Set the number of rows in the dataset
nr <- nrow(days_since)

# Sample 40 observations from the dataset
sampled <- sample_n(days_since, 50)

# Extract the temperature and humidity values from the sampled dataset
temp <- sampled$temp
hum <- sampled$hum

# Combine the temperature and humidity values into a single dataframe
th <- inner_join(data.frame(temp), data.frame(hum), by = character())

# Add a new column to store the predictions
th$predicted <- 0.0

# Loop through each row in the temperature/humidity dataframe
for(i in 1:nrow(th)){
  
  # Copy the original dataset to a new variable
  r <- days_since
  
  # Set the temperature and humidity values in the new dataset to the current row's values
  r[["temp"]] <- th[["temp"]][i]
  r[["hum"]] <- th[["hum"]][i]
  
  # Make a prediction using the random forest model
  sal <- predict(model.rf, r)$predicted
  
  # Calculate the average of all the predictions
  th[["predicted"]][i] <- sum(sal) / nr
}
```


```{r 2d_pdp_plot}
# Create a heatmap using ggplot2
ggplot(th, aes(x=temp, y=hum)) + 
  # Use the predicted values to fill the tiles
  geom_tile(aes(fill=predicted, width=10, height=15)) + 
  # Add a rug plot to show the distribution of the sampled points
  geom_rug(alpha=0.01) +
  # Add labels to the x and y axes
  labs(x = "Temperature (°C)", y = "Humidity (%)") +
  # Add a title to the colorbar
  scale_fill_continuous(name = "ypred")
```

```{r densities}

results2 <- select(sampled, temp, hum, cnt)
len <- nrow(sampled)
for(c in names(results2)[1:2])
{
  for(i in 1:len){
    r <- sampled
    r[[c]] <- sampled[[c]][i]
    pred <- predict(model.rf, r)$predicted
    results2[[c]][i] <- sum(pred) / len
  }
}


plot_22 <- ggplot(sampled, aes(x=temp, y=results2$temp)) + 
          geom_line() + 
          ylim(c(0,6000)) + 
          geom_rug(alpha=0.1, sides="b") + 
          xlab("Temperature (ºC)") + 
          ylab("Predicted number of bike rentals")

plot_23 <- ggplot(sampled, aes(x=hum, y=results2$hum)) + 
          geom_line() + 
          ylim(c(0,6000)) + 
          geom_rug(alpha=0.1, sides="b") + 
          xlab("Humidity (%)")

subplot(plot_22, plot_23,  
          shareX = FALSE, 
          shareY = TRUE, 
          titleX = TRUE)
  
```

## INTERPRETATION
In the 2D PDP, we observe the same phenomena as in the PDP of temperature and humidity. The maximum number of bike rentals occurs at a temperature of around 20 degrees Celsius and a humidity below 50%. On the other hand, the minimum number of bike rentals occurs when the temperature is extremely low and the humidity is very high. This confirms what we saw in the PDPs, where we observed a certain independence between the effect of temperature and humidity.

While the humidity is below 50%, the maximum number of bike rentals is achieved. However, the number of rentals decreases as the humidity increases beyond this threshold. In contrast, starting from the minimum temperature, an increase in temperature leads to an increase in bike rentals until it reaches a maximum at around 17.5 degrees Celsius. Beyond this point, the number of bike rentals remains constant until the temperature reaches 25 degrees Celsius, after which it decreases again.

Based on the observations from the 1-dimensional PDPs and the 2D PDP The effects of temperature and humidity are independent. However, it is important to note that the model has not been trained on certain scenarios where there are not many real observations, and therefore, the explanations may not be reliable. It is also important to know the number of observations for each possible interaction of the variables in the dataset. Therefore, to make more accurate predictions, it may be necessary to use or collect more data, or refine the model to include more scenarios.

## 3.- PDP to explain the price of a house.

### EXERCISE:
Apply the previous concepts to predict the price of a house from the database kc_house_data.csv. In this case, use again a random forest approximation for the prediction based on the features bedrooms, bathrooms, sqft_living, sqft_lot, floors and yr_built.Use the partial dependence plot to visualize the relationships the model learned.

> **BE CAREFUL: due to the size, extract a set of random samples from the BBDD before generating the data for the Partial Dependency Plot.** 

### QUESTION:
Analyse the influence of bedrooms, bathrooms, sqft_living and floors on the predicted price.

```{r}
h <- read.csv("data/kc_house_data.csv")

set.seed(100)

sampled <- sample_n(h, 1000)
sampled <- select(sampled, bedrooms, bathrooms, sqft_living, sqft_lot, floors, yr_built, price)

model <- rfsrc(price~., data=sampled)

results3 <- select(sampled, bedrooms, bathrooms, sqft_living, floors, price)
nr <- nrow(sampled)
for(c in names(results)[1:4])
{
  for(i in 1:nr){
    r <- sampled
    r[[c]] <- sampled[[c]][i]
    sal <- predict(model, r)$predicted
    results[[c]][i] <- sum(sal) / nr
  }
}
```

```{r}
plot_31 <- ggplot(sampled, aes(x=bedrooms, y=results$bedrooms)) + geom_line() + geom_rug(alpha=0.1, sides="b") + ylab("Prediction") + xlab("Bedrooms")

plot_32 <- ggplot(sampled, aes(x=bathrooms, y=results$bathrooms)) + geom_line() + geom_rug(alpha=0.1, sides="b") + xlab("Bathrooms")

plot_33 <- ggplot(sampled, aes(x=sqft_living, y=results$sqft_living)) + geom_line() + geom_rug(alpha=0.1, sides="b") + xlab("Sqft Living")

plot_34 <- ggplot(sampled, aes(x=floors, y=results$floors)) + geom_line() + geom_rug(alpha=0.1, sides="b")+ xlab("Floors")

subplot(plot_31, plot_32, plot_33, plot_34, titleX = TRUE, shareX = FALSE)
```

## INTERPRETATION

**'bedrooms'**: This variable behaves in an interesting way, starting from 0 bedrooms, the more bedrooms, the cheaper the property will be, up to 3 bedrooms. From this point on, the trend reverses, and the more bedrooms, the higher the price. However, this cannot be asserted with complete confidence, as there are few observations for the variable when there are 0 or more than 6 bedrooms.

**'bathrooms'**: It can be clearly seen that the more bathrooms, the higher the price of the property. However, this statement is not entirely reliable for 0 or more than 4 bathrooms, as there are hardly any training samples with these values.

**'Sqft_living'**: We can clearly see that the larger the living room area, the more expensive the property. However, this statement is in doubt for values less than 560 square feet and greater than 4900 square feet.

**'Floors'**: In this variable, we can assert that the higher the number of floors, the higher the price of the property, and this is a reliable explanation, as there are observations for all values in the training set.
